#!/usr/bin/env python3
import rclpy
import numpy as np
from rclpy.node import Node
from sensor_msgs.msg import Joy
from std_msgs.msg import Float64MultiArray

class JointTeleopNode(Node):
    def __init__(self):
        super().__init__('joint_teleop_node')
        
        # Configuration
        self.declare_parameter('joystick_axis_0', 0)        # Left stick X for joint_0
        self.declare_parameter('joystick_axis_1', 1)        # Left stick Y for joint_1
        self.declare_parameter("joystick_axis_2", 4)        # Right stick Y for joint_2
        self.declare_parameter('joint_speed_scale', 1)
        self.declare_parameter('max_joint_position', 1.5707963)  # ~90 degrees
        self.declare_parameter('min_joint_position', -1.5707963) # ~-90 degrees
        self.axis_0 = self.get_parameter('joystick_axis_0').value
        self.axis_1 = self.get_parameter('joystick_axis_1').value
        self.axis_2 = self.get_parameter('joystick_axis_2').value
        self.speed_scale = self.get_parameter('joint_speed_scale').value
        self.max_pos = self.get_parameter('max_joint_position').value
        self.min_pos = self.get_parameter('min_joint_position').value
        
        # Track current positions for all joints (12 joints total)
        self.joint_positions = [0.0] * 12  # FR, FL, BR, BL (3 per leg)
        
        # Publisher for joint commands (read by joint_states_publisher)
        self.pub = self.create_publisher(
            Float64MultiArray,
            '/joint_commands',
            10
        )
        
        # Subscriber to joystick input
        self.sub = self.create_subscription(
            Joy,
            '/joy',
            self.joy_callback,
            10
        )
        
        self.get_logger().info('Joint teleoperation node started. PS3 controller ready.')
        self.get_logger().info(f'  Left stick X (axis {self.axis_0}) -> joint_0')
        self.get_logger().info(f'  Left stick Y (axis {self.axis_1}) -> joint_1')
        self.get_logger().info(f'  Right stick Y (axis {self.axis_2}) -> joint_2')
    
    def joy_callback(self, msg: Joy):
        """
        Process joystick input and publish joint commands.
        PS3 Controller mapping:
        - Left stick X: controls joint_0
        - Left stick Y: controls joint_1
        """
        # Get joystick values
        if len(msg.axes) > max(self.axis_0, self.axis_1, self.axis_2):
            input_0 = msg.axes[self.axis_0]
            input_1 = msg.axes[self.axis_1]
            input_2 = msg.axes[self.axis_2]

            target_pos_0 = input_0 * self.max_pos
            target_pos_1 = input_1 * self.max_pos
            target_pos_2 = input_2 * self.max_pos
            
            # Update joint positions (integrate stick movement)

            x = -target_pos_1 / 10
            zl = target_pos_0 / 10 + 0.065
            zr = target_pos_0 / 10 - 0.065
            y = -(0.18 * np.sqrt(2)) + target_pos_2 / 50

            dl = np.sqrt(y ** 2 + zl ** 2 - 0.065 ** 2)
            dr = np.sqrt(y ** 2 + zr ** 2 - 0.065 ** 2)
            
            gl = np.sqrt(dl ** 2 + x ** 2)
            gr = np.sqrt(dr ** 2 + x ** 2)

            theta1l = np.arctan2(y, zl) + np.arctan2(dl, 0.065)

            theta3l = np.arccos((gl ** 2 - 0.0648)/0.0648)

            theta2l = np.arctan2(x, dl) + np.arcsin(0.18 * np.sin(theta3l) / gl)

            theta1r = np.arctan2(y, zr) + np.arctan2(dr, -0.065)

            theta3r = np.arccos((gr ** 2 - 0.0648)/0.0648)

            theta2r = np.arctan2(x, dr) + np.arcsin(0.18 * np.sin(theta3r) / gr)

            self.joint_positions[0] = theta1l
            self.joint_positions[1] = theta2l
            self.joint_positions[2] = theta3l

            self.joint_positions[3] = theta1r
            self.joint_positions[4] = -theta2r
            self.joint_positions[5] = theta3r

            self.joint_positions[6] = -theta1l
            self.joint_positions[7] = theta2l
            self.joint_positions[8] = theta3l

            self.joint_positions[9] = -theta1r
            self.joint_positions[10] = -theta2r
            self.joint_positions[11] =  theta3r

            # Publish commands
            cmd_msg = Float64MultiArray()
            cmd_msg.data = self.joint_positions
            self.pub.publish(cmd_msg)

def main(args=None):
    rclpy.init(args=args)
    node = JointTeleopNode()
    rclpy.spin(node)
    rclpy.shutdown()

if __name__ == '__main__':
    main()